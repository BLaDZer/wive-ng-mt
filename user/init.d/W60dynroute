#!/bin/sh

# if app not exist
if [ ! -e /bin/zebra ] || [ ! -e /bin/ripd ]; then
    exit 0
fi

# get params
. /etc/scripts/global.sh

if [ "$OperationMode" = "0" ]; then
    exit 0
fi

LOG="logger -t dynroute"

start() {
    eval `nvram_buf_get 2860 RIPEnable Password Login HostName`
    if [ "$SysLogd" = "1" ]; then
	logto="log syslog"
    fi
    if [ "$RIPEnable" = "1" ] && [ -e /bin/zebra ]; then
	# confog and start zebra
	printf "hostname $HostName
    		password $Password
    		enable password $Password
    		$logto" > /etc/zebra.conf
	$LOG "Starting ZEBRA"
	zebra -u $Login -g $Login -d -f /etc/zebra.conf
    fi
    if [ "$RIPEnable" = "1" ] && [ -e /bin/ripd ]; then
	# confog and start ripd
	printf "hostname $HostName
    		password $Password
    		enable password $Password
    		router rip
    		version 2
		network $wan_if
		network $lan_if
		" > /etc/ripd.conf
	if [ "$wan_if" != "$real_wan_if" ]; then
	printf "network $real_wan_if
		" >> /etc/ripd.conf
	fi
    	printf "$logto
		" >> /etc/ripd.conf
	$LOG "Starting RIPD"
	ripd -u $Login -g $Login -f /etc/ripd.conf -d
    fi
}

stop() {
    pid=`pidof zebra`
    if [ "$pid" != "" ]; then
	$LOG "Stopping ZEBRA"
        # terminate zebra daemon
        while killall -q zebra; do
            usleep 500000
            killall -q -SIGKILL zebra
        done
    fi
    pid=`pidof ripd`
    if [ "$pid" != "" ]; then
	$LOG "Stopping RIPD"
        # terminate ripd daemon
        while killall -q ripd; do
            usleep 500000
            killall -q -SIGKILL ripd
        done
    fi
}

case "$1" in
        start)
            start
            ;;

        stop)
            stop
            ;;

        restart)
            stop
            start
            ;;

        *)
            echo $"Usage: $0 {start|stop|restart}"
esac

#!/bin/sh

# if app not exist
if [ ! -e /bin/irqbalance ]; then
    exit 0
fi

#include global config
. /etc/scripts/global.sh

#if not SMP
if [ "$CONFIG_SMP" = "" ]; then
    exit 0
fi

LOG="logger -t irqbalance"

start() {
    get_param

    # tune RPS
    echo 16384 > /proc/sys/net/core/rps_sock_flow_entries
    echo 2048 > /sys/class/net/$phys_lan_if/queues/rx-0/rps_flow_cnt
    echo 2048 > /sys/class/net/$phys_wan_if/queues/rx-0/rps_flow_cnt
    echo 2048 > /sys/class/net/$first_wlan_root_if/queues/rx-0/rps_flow_cnt
    echo 2048 > /sys/class/net/$second_wlan_root_if/queues/rx-0/rps_flow_cnt

    if [ "$IRQBalance" = "auto" ] || [ "$IRQBalance" = "router" ]; then
	$LOG "Start irqbalance routing/wifi optimize mode"
	if [ $cpunum = "4" ]; then
	    echo 2 > /proc/irq/11/smp_affinity  #GMAC
	    echo 4 > /proc/irq/12/smp_affinity  #PCIe0
	    echo 8 > /proc/irq/32/smp_affinity #PCIe1
	    echo 8 > /proc/irq/33/smp_affinity #PCIe2
	    echo 8 > /proc/irq/27/smp_affinity #VPN
	    echo 8 > /proc/irq/28/smp_affinity #SDXC
	    echo 8 > /proc/irq/30/smp_affinity #USB

	    # phys
	    echo 3 > /sys/class/net/$first_wlan_root_if/queues/rx-0/rps_cpus
	    echo 3 > /sys/class/net/$first_wlan_root_if/queues/tx-0/xps_cpus
	    echo 3 > /sys/class/net/$second_wlan_root_if/queues/rx-0/rps_cpus
	    echo 3 > /sys/class/net/$second_wlan_root_if/queues/tx-0/xps_cpus
	    echo 3 > /sys/class/net/$phys_lan_if/queues/rx-0/rps_cpus
	    echo 3 > /sys/class/net/$phys_lan_if/queues/tx-0/xps_cpus
	    echo 3 > /sys/class/net/$phys_wan_if/queues/rx-0/rps_cpus
	    echo 3 > /sys/class/net/$phys_wan_if/queues/tx-0/xps_cpus

	    # VPN
	    find /sys -type d -name 'ppp[0-10]' | while read dev_ppp; do
		echo 4 > $dev_ppp/queues/rx-0/rps_cpus
		echo 4 > $dev_ppp/queues/tx-0/xps_cpus
	    done
	elif [ $cpunum = "2" ]; then
	    echo 2 > /proc/irq/11/smp_affinity  #GMAC
	    echo 1 > /proc/irq/12/smp_affinity  #PCIe0
	    echo 2 > /proc/irq/32/smp_affinity #PCIe1
	    echo 2 > /proc/irq/33/smp_affinity #PCIe2
	    echo 1 > /proc/irq/27/smp_affinity #VPN
	    echo 1 > /proc/irq/28/smp_affinity #SDXC
	    echo 1 > /proc/irq/30/smp_affinity #USB

	    # phys
	    echo 2 > /sys/class/net/$first_wlan_root_if/queues/rx-0/rps_cpus
	    echo 2 > /sys/class/net/$first_wlan_root_if/queues/tx-0/xps_cpus
	    echo 1 > /sys/class/net/$second_wlan_root_if/queues/rx-0/rps_cpus
	    echo 1 > /sys/class/net/$second_wlan_root_if/queues/tx-0/xps_cpus
	    echo 2 > /sys/class/net/$phys_lan_if/queues/rx-0/rps_cpus
	    echo 2 > /sys/class/net/$phys_lan_if/queues/tx-0/xps_cpus
	    echo 2 > /sys/class/net/$phys_wan_if/queues/rx-0/rps_cpus
	    echo 2 > /sys/class/net/$phys_wan_if/queues/tx-0/xps_cpus

	    # VPN
	    find /sys -type d -name 'ppp[0-10]' | while read dev_ppp; do
		echo 2 > $dev_ppp/queues/rx-0/rps_cpus
		echo 2 > $dev_ppp/queues/tx-0/xps_cpus
	    done
	fi
    elif [ "$IRQBalance" = "storage" ]; then
	$LOG "Start irqbalance storage/local services optimize mode"
	if [ $cpunum = "4" ]; then
	    echo 2 > /proc/irq/11/smp_affinity  #GMAC
	    echo 4 > /proc/irq/12/smp_affinity  #PCIe0
	    echo 4 > /proc/irq/32/smp_affinity #PCIe1
	    echo 8 > /proc/irq/33/smp_affinity #PCIe2
	    echo 8 > /proc/irq/27/smp_affinity #VPN
	    echo 8 > /proc/irq/28/smp_affinity #SDXC
	    echo 8 > /proc/irq/30/smp_affinity #USB

	    # phys
	    echo f > /sys/class/net/$first_wlan_root_if/queues/rx-0/rps_cpus
	    echo f > /sys/class/net/$first_wlan_root_if/queues/tx-0/xps_cpus
	    echo f > /sys/class/net/$second_wlan_root_if/queues/rx-0/rps_cpus
	    echo f > /sys/class/net/$second_wlan_root_if/queues/tx-0/xps_cpus
	    echo c > /sys/class/net/$phys_lan_if/queues/rx-0/rps_cpus
	    echo c > /sys/class/net/$phys_lan_if/queues/tx-0/xps_cpus
	    echo c > /sys/class/net/$phys_wan_if/queues/rx-0/rps_cpus
	    echo c > /sys/class/net/$phys_wan_if/queues/tx-0/xps_cpus

	    # VPN
	    find /sys -type d -name 'ppp[0-10]' | while read dev_ppp; do
		echo 1 > $dev_ppp/queues/rx-0/rps_cpus
		echo 1 > $dev_ppp/queues/tx-0/xps_cpus
	    done
	elif [ $cpunum = "2" ]; then
	    echo 1 > /proc/irq/11/smp_affinity  #GMAC
	    echo 1 > /proc/irq/12/smp_affinity  #PCIe0
	    echo 1 > /proc/irq/32/smp_affinity #PCIe1
	    echo 1 > /proc/irq/33/smp_affinity #PCIe2
	    echo 1 > /proc/irq/27/smp_affinity #VPN
	    echo 2 > /proc/irq/28/smp_affinity #SDXC
	    echo 2 > /proc/irq/30/smp_affinity #USB

	    # phys
	    echo 1 > /sys/class/net/$first_wlan_root_if/queues/rx-0/rps_cpus
	    echo 1 > /sys/class/net/$first_wlan_root_if/queues/tx-0/xps_cpus
	    echo 1 > /sys/class/net/$second_wlan_root_if/queues/rx-0/rps_cpus
	    echo 1 > /sys/class/net/$second_wlan_root_if/queues/tx-0/xps_cpus
	    echo 1 > /sys/class/net/$phys_lan_if/queues/rx-0/rps_cpus
	    echo 1 > /sys/class/net/$phys_lan_if/queues/tx-0/xps_cpus
	    echo 1 > /sys/class/net/$phys_wan_if/queues/rx-0/rps_cpus
	    echo 1 > /sys/class/net/$phys_wan_if/queues/tx-0/xps_cpus

	    # VPN
	    find /sys -type d -name 'ppp[0-10]' | while read dev_ppp; do
		echo 2 > $dev_ppp/queues/rx-0/rps_cpus
		echo 2 > $dev_ppp/queues/tx-0/xps_cpus
	    done
	fi
    fi
    if [ "$IRQBalance" = "auto" ]; then
	$LOG "Start irqbalance auto mode"
	irqbalance $banirq
    fi
}

stop() {
    pid=`pidof irqbalance`
    if [ "$pid" != "" ]; then
	$LOG "Stopping irqbalance"
	killall -q irqbalance
	killall -q -SIGKILL irqbalance
    fi
}

get_param() {
    eval `nvram_buf_get 2860 IRQBalance`
    cpunum=`grep -c processor /proc/cpuinfo`
    banirq=`grep ipi_ /proc/interrupts | cut -f1 -d":" | awk {' print "--banirq="$1 '}`
}

case "$1" in
        start)
            start
            ;;

	stop)
            stop
            ;;

	restart)
            stop
            start
            ;;
        *)
            echo $"Usage: $0 {start|stop|reload|restart}"
esac
